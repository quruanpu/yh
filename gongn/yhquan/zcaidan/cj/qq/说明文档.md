# 抢券活动管理模块

## 概述

本模块通过云函数代理 SCM Promotion API，实现抢券活动的完整管理。

**云函数地址：** `https://1317825751-21j36twzqr.ap-guangzhou.tencentscf.com`
**领券页面前缀：** `https://dian.ysbang.cn/#/grabCoupon?id={活动ID}`

## 文件结构

| 文件 | 说明 |
|------|------|
| `ewm.js` | 前端业务模块（EwmYewu） |
| `yangshi.js` | 样式注入模块（EwmYangshi） |
| `云函数/index.js` | 腾讯云函数（Node.js 16.13） |

## 云函数 API（4个action）

所有请求均为 POST，Content-Type: `application/json`。

### 1. queryActivity - 根据优惠券ID查找抢券活动

```json
{
  "action": "queryActivity",
  "credentials": { "token": "...", "provider_id_m": "...", "cookies": {} },
  "couponTypeId": 1920006
}
```

**返回：** `{ activityId: 445308 }` 或 `null`（未找到）

### 2. createActivity - 根据优惠券ID创建抢券活动

```json
{
  "action": "createActivity",
  "credentials": { "token": "...", "provider_id_m": "...", "cookies": {} },
  "eventName": "500/99抢券活动",
  "couponTypeId": 1920006,
  "couponNum": 5,
  "couponAmount": 10000,
  "tagBeginTimeDate": "2026-02-08",
  "beginTimeDate": "2026-02-08",
  "endTimeDate": "2026-02-10",
  "storeSubTypes": [-1],
  "isLimitArea": 0,
  "selectedAreaIds": []
}
```

| 参数 | 说明 |
|------|------|
| `couponNum` | 单店上限（1~5） |
| `couponAmount` | 总量上限（非券面额） |
| `storeSubTypes` | 领券对象，`[-1]`=全部，`[2,4,5]`=指定类型 |
| `tagBeginTimeDate` | 显示开始日期 |
| `beginTimeDate` | 开抢日期 |
| `endTimeDate` | 结束日期（显示时间不得超过3天） |

**返回：** 活动ID（如 `445308`）

### 3. getActivity - 根据活动ID获取详情

```json
{
  "action": "getActivity",
  "credentials": { "token": "...", "provider_id_m": "...", "cookies": {} },
  "id": 445308
}
```

**返回：**
```json
{
  "id": 445308,
  "eventName": "500/99抢券活动",
  "couponTypeId": 1920006,
  "couponNum": 5,
  "couponAmount": 10000,
  "isClose": 0,
  "storeSubtypes": "-1",
  "isLimitArea": 0,
  "beginTimeDate": "2026-02-08",
  "beginTimeHms": "00:00:00",
  "endTimeDate": "2026-02-10",
  "endTimeHms": "23:59:59",
  "tagBeginTime": 1770480000
}
```

### 4. editActivity - 修改抢券活动

```json
{
  "action": "editActivity",
  "credentials": { "token": "...", "provider_id_m": "...", "cookies": {} },
  "id": 445308,
  "eventName": "500/99抢券活动",
  "couponTypeId": 1920006,
  "couponNum": 2,
  "couponAmount": 5000,
  "tagBeginTimeDate": "2026-02-09",
  "beginTimeDate": "2026-02-09",
  "endTimeDate": "2026-02-11",
  "storeSubTypes": [2, 4, 5],
  "isLimitArea": 0,
  "selectedAreaIds": [],
  "deselectedAreaIds": []
}
```

**注意：** `id` 为必填（活动ID），其余字段按需传入。

**返回：** 活动ID（如 `445308`）

## 前端调用方式（EwmYewu）

### 自动创建二维码链接（点击图标触发）
```js
EwmYewu.start(coupon);  // coupon 对象来自优惠券搜索结果
```

### 根据优惠券ID查找活动
```js
const result = await EwmYewu.queryByCouponId(1920006);
// result = { activityId: 445308 } 或 null
```

### 获取活动详情
```js
const detail = await EwmYewu.getActivityDetail(445308);
// detail = { id, eventName, couponNum, couponAmount, ... }
```

### 修改活动
```js
await EwmYewu.editActivity(445308, {
    eventName: '新名称',
    couponNum: 3,
    couponAmount: 5000,
    tagBeginTimeDate: '2026-02-09',
    beginTimeDate: '2026-02-09',
    endTimeDate: '2026-02-11',
    storeSubTypes: [2, 4, 5],
    selectedAreaIds: [],
    deselectedAreaIds: []
});
```

## 业务约束

- 显示时间（tagBeginTime → endTime）**不得超过3天**
- 单店上限 `couponNum`：1~5，且必须 ≤ 总量上限 `couponAmount`
- `storeSubTypes: [-1]` 表示全部对象，指定类型用数组如 `[2, 4, 5]`
- `isLimitArea: 0` 表示不限区域，`1` 表示限制区域（需配合 `selectedAreaIds`）